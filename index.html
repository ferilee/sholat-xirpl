<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Kehadiran Sholat - XI RPL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">🕌 Form Kehadiran Sholat</h1>
            <p class="text-gray-600 text-center mb-4">SMK Negeri Pasirian - Kelas XI RPL</p>
            
            <!-- Teacher Card -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
                <div class="flex items-center justify-center">
                    <img src="https://live.staticflickr.com/65535/54509797172_fa540c8b67_b.jpg"
                          alt="Foto Guru"
                          class="w-16 h-16 rounded-full object-cover border-4 border-white shadow-lg mr-4"
                         onerror="this.src=''; this.alt='Avatar tidak dapat dimuat'; this.style.display='none';">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-800">👨‍🏫 Guru Pengampu</h3>
                        <p class="text-green-600 font-medium">Feri Dwi Hermawan, S.Pd.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prayer Selection and Date -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-lg font-semibold text-gray-700 mb-3">Pilih Sholat:</label>
                    <select id="prayerSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none transition-colors">
                        <option value="">-- Pilih Sholat --</option>
                        <option value="dhuha">🌅 Sholat Dhuha</option>
                        <option value="dhuhur">☀️ Sholat Dhuhur</option>
                        <option value="ashar">🌇 Sholat Ashar</option>
                        <option value="jumat">🕌 Sholat Jum'at</option>
                    </select>
                </div>
                <div>
                    <label class="block text-lg font-semibold text-gray-700 mb-3">Tanggal:</label>
                    <input type="date" id="attendanceDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none transition-colors">
                </div>
            </div>
            
            <!-- Google Form Info -->
            <div id="formInfo" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start">
                    <span class="text-blue-500 text-xl mr-2">📋</span>
                    <div>
                        <h4 class="font-semibold text-blue-800">Data akan disimpan via Google Form</h4>
                        <p class="text-blue-700 text-sm">✅ Google Form terintegrasi dengan baik</p>
                        <p class="text-blue-600 text-xs mt-1">Data otomatis tersimpan di Google Sheets</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student List -->
        <div id="studentList" class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Daftar Siswa XI RPL</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="markAllStatus('sholat')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                        🕌 Semua Sholat
                    </button>
                    <button onclick="markAllStatus('berhalangan')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                        🚫 Semua Berhalangan
                    </button>
                    <button onclick="markAllStatus('tidak_sholat')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                        ❌ Semua Tidak Sholat
                    </button>
                </div>
            </div>
            
            <div id="studentsContainer" class="space-y-3">
                <!-- Students will be loaded here -->
            </div>
            
            <!-- Summary -->
            <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold text-gray-700 mb-2">Ringkasan Kehadiran Sholat:</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <div class="text-xl font-bold text-green-600" id="sholatCount">0</div>
                        <div class="text-xs text-green-700">Sholat</div>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <div class="text-xl font-bold text-yellow-600" id="berhalaganCount">0</div>
                        <div class="text-xs text-yellow-700">Berhalangan</div>
                    </div>
                    <div class="bg-red-100 p-3 rounded-lg">
                        <div class="text-xl font-bold text-red-600" id="tidakSholatCount">0</div>
                        <div class="text-xs text-red-700">Tidak Sholat</div>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <div class="text-xl font-bold text-gray-600" id="totalCount">0</div>
                        <div class="text-xs text-gray-700">Total</div>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="mt-6 text-center">
                <button onclick="submitToGoogleForm()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors shadow-lg">
                    💾 Simpan ke Google Form
                </button>
                <div class="mt-2 text-sm text-gray-600">
                    Data akan dikirim ke Google Form dan tersimpan otomatis di Google Sheets
                </div>
            </div>
        </div>
        
        <!-- Progress Modal -->
        <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">⏳</div>
                    <h3 class="text-xl font-semibold text-gray-800">Menyimpan Data</h3>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Progress:</span>
                        <span id="progressText">0/0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <p class="text-gray-600 text-sm text-center" id="progressMessage">
                    Mengirim data ke Google Form...
                </p>
            </div>
        </div>
        
        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mt-6">
            <div class="flex items-center">
                <span class="text-xl mr-2">✅</span>
                <span id="successContent">Data kehadiran sholat berhasil disimpan!</span>
            </div>
        </div>
        
        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mt-6">
            <div class="flex items-start">
                <span class="text-xl mr-2">❌</span>
                <div>
                    <div class="font-semibold mb-2">Error:</div>
                    <div id="errorContent" class="text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Google Form & Sheets Links -->
        <div class="mt-6 text-center space-y-2">
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfmepe4On3uCQRv2H3J8yN-mjTxzmUUBAh9wnB0AjWol-DHdg/viewform" 
               target="_blank" class="text-blue-600 hover:text-blue-800 text-sm block">
                📝 Lihat Google Form
            </a>
            <a href="https://docs.google.com/spreadsheets/d/1FAIpQLSfmepe4On3uCQRv2H3J8yN-mjTxzmUUBAh9wnB0AjWol-DHdg/edit?usp=sharing" 
               target="_blank" class="text-green-600 hover:text-green-800 text-sm block">
                📊 Lihat Google Sheets
            </a>
        </div>
    </div>

    <script>
        // Data and configuration
        let studentsData = [];
        let currentPrayer = '';
        
        // Google Form Configuration - SUDAH DIKONFIGURASI
        const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfmepe4On3uCQRv2H3J8yN-mjTxzmUUBAh9wnB0AjWol-DHdg/formResponse';
        
        // Field IDs dari Google Form Anda - SUDAH DITEMUKAN
        const FORM_FIELD_IDS = {
            timestamp: 'entry.1189730886',
            date: 'entry.398222560',
            class: 'entry.437696563',
            prayer: 'entry.1674162174',
            studentName: 'entry.2049938220',
            status: 'entry.1488425238',
            nis: 'entry.380156165'
        };

        // Data siswa XI RPL
        const xiRplStudents = [
            'AULIA AZZARA NUR RAMDANI',
            'CHIKA AFINSA RAMADHANI', 
            'RENO FIRMANSYAH',
            'RISQI ADITYA',
            'AUGUSTAV BRILLYAN SINDUARTHA',
            'PUTRA PUGUH PRADANA',
            'SALSAHIRA DUWI APRILIA',
            'WAHYU EKA ADI PRATAMA',
            'FIRDAUS ZIDDAN AZZAINURI',
            'MARVELINO ALFRADO',
            'MUHAMMAD EDI SANTOSO',
            'NABILA NUR AZIZAH',
            'ADINDA ANEZTYA ZAHRA',
            'FARHAN DHIYA\'UL HAQ',
            'RAFAEL ONIL MULYA PUTRA',
            'REYHAN ALIF RAMADHAN',
            'AYU DWI HANAFI',
            'BRIANDA WISNU YUSENA',
            'RAFI ARDIANSYAH EGI RAMADHAN',
            'VALENTINO AFASHA SALEH',
            'DINDA MAI SAFIRA',
            'MUHAMMAD HATTA PRIMA NURRAHMAN',
            'MUHAMMAD IRFAN KHOIRUL HIDAYAH',
            'NUR RAHMAD HIDAYAT'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application with Google Form integration...');
            
            // Set default date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            
            // Set default prayer
            currentPrayer = 'dhuha';
            document.getElementById('prayerSelect').value = 'dhuha';
            
            // Load students data
            loadStudentsData();
        });

        // Load students from CSV or use default
        async function loadStudentsData() {
            try {
                // Try to load from CSV first
                const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNxfl64ybd5HEX-Ln3ubR8C-SxModDRkPVuRpShlUDX2UCRgKib2cIqXtsUPT4d0rJY_gkaCQVOTSb/pub?gid=1025174012&single=true&output=csv';
                const response = await fetch(csvUrl);
                
                if (response.ok) {
                    const csvText = await response.text();
                    studentsData = parseStudentsCSV(csvText);
                    console.log('Loaded students from CSV:', studentsData.length);
                } else {
                    throw new Error('CSV not available');
                }
            } catch (error) {
                console.log('Using default students data');
                // Use default data if CSV fails
                studentsData = xiRplStudents.map((name, index) => ({
                    name: name,
                    nis: (index + 1).toString().padStart(3, '0'),
                    class: 'XI RPL',
                    gender: Math.random() > 0.5 ? 'Laki-laki' : 'Perempuan',
                    status: 'sholat'
                }));
            }
            
            displayStudents();
        }

        function parseStudentsCSV(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length <= 1) return [];
                
                const students = [];
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                // Find column indices
                const nameIndex = headers.findIndex(h => h.includes('nama'));
                const nisIndex = headers.findIndex(h => h.includes('nis'));
                const classIndex = headers.findIndex(h => h.includes('kelas'));
                const genderIndex = headers.findIndex(h => h.includes('kelamin') || h.includes('gender'));
                
                for (let i = 1; i < lines.length; i++) {
                    const cells = lines[i].split(',');
                    if (cells.length < 2) continue;
                    
                    const name = nameIndex >= 0 ? cells[nameIndex]?.trim() : '';
                    const nis = nisIndex >= 0 ? cells[nisIndex]?.trim() : '';
                    const studentClass = classIndex >= 0 ? cells[classIndex]?.trim() : 'XI RPL';
                    const gender = genderIndex >= 0 ? cells[genderIndex]?.trim() : '';
                    
                    if (name && studentClass.includes('XI RPL')) {
                        students.push({
                            name: name,
                            nis: nis || (i).toString().padStart(3, '0'),
                            class: studentClass,
                            gender: gender,
                            status: 'sholat'
                        });
                    }
                }
                
                return students;
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return [];
            }
        }

        // Display Students
        function displayStudents() {
            const container = document.getElementById('studentsContainer');
            container.innerHTML = '';
            
            const prayerIcon = currentPrayer === 'dhuha' ? '🌅' : 
                              currentPrayer === 'dhuhur' ? '☀️' :
                              currentPrayer === 'ashar' ? '🌇' : '🕌';
            
            studentsData.forEach((student, index) => {
                const studentCard = document.createElement('div');
                studentCard.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
                
                studentCard.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-4">
                            <span class="text-green-600 font-semibold">${index + 1}</span>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">${student.name}</h4>
                            <p class="text-sm text-gray-600">${prayerIcon} NIS: ${student.nis}</p>
                            ${student.gender ? `<p class="text-xs text-gray-500">${student.gender}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-1 flex-wrap">
                        <button onclick="updateStatus(${index}, 'sholat')" 
                                class="px-3 py-2 rounded-lg transition-colors text-sm ${student.status === 'sholat' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-100'}">
                            🕌 Sholat
                        </button>
                        <button onclick="updateStatus(${index}, 'berhalangan')" 
                                class="px-3 py-2 rounded-lg transition-colors text-sm ${student.status === 'berhalangan' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-yellow-100'}">
                            🚫 Berhalangan
                        </button>
                        <button onclick="updateStatus(${index}, 'tidak_sholat')" 
                                class="px-3 py-2 rounded-lg transition-colors text-sm ${student.status === 'tidak_sholat' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-red-100'}">
                            ❌ Tidak Sholat
                        </button>
                    </div>
                `;
                
                container.appendChild(studentCard);
            });
            
            updateSummary();
        }

        function updateStatus(index, status) {
            studentsData[index].status = status;
            displayStudents();
        }

        function markAllStatus(status) {
            studentsData.forEach(student => student.status = status);
            displayStudents();
        }

        function updateSummary() {
            const sholatCount = studentsData.filter(s => s.status === 'sholat').length;
            const berhalaganCount = studentsData.filter(s => s.status === 'berhalangan').length;
            const tidakSholatCount = studentsData.filter(s => s.status === 'tidak_sholat').length;
            const totalCount = studentsData.length;
            
            document.getElementById('sholatCount').textContent = sholatCount;
            document.getElementById('berhalaganCount').textContent = berhalaganCount;
            document.getElementById('tidakSholatCount').textContent = tidakSholatCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        // Handle prayer selection change
        document.getElementById('prayerSelect').addEventListener('change', function() {
            currentPrayer = this.value;
            if (studentsData.length > 0) {
                displayStudents();
            }
        });

        // Main function to submit to Google Form
        async function submitToGoogleForm() {
            const date = document.getElementById('attendanceDate').value;
            const prayer = document.getElementById('prayerSelect').value;
            
            if (!date || !prayer) {
                showError('Mohon lengkapi tanggal dan pilih jenis sholat!');
                return;
            }
            
            const prayerName = getPrayerName(prayer);
            
            // Show progress modal
            showProgressModal(0, studentsData.length);
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // Submit each student individually
            for (let i = 0; i < studentsData.length; i++) {
                const student = studentsData[i];
                
                try {
                    await submitStudentData(student, date, prayerName);
                    successCount++;
                } catch (error) {
                    console.error(`Error submitting data for ${student.name}:`, error);
                    errorCount++;
                    errors.push(`${student.name}: ${error.message}`);
                }
                
                // Update progress
                updateProgressModal(i + 1, studentsData.length, successCount, errorCount);
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Hide progress modal
            hideProgressModal();
            
            // Show results
            if (errorCount === 0) {
                showSuccess(`✅ Berhasil menyimpan data semua ${successCount} siswa!`);
            } else if (successCount > 0) {
                showSuccess(`✅ ${successCount} data berhasil disimpan, ${errorCount} gagal.`);
            } else {
                showError(`❌ Gagal menyimpan semua data. Error: ${errors.join(', ')}`);
            }
        }

        // Submit individual student data to Google Form
        async function submitStudentData(student, date, prayerName) {
            const formData = new URLSearchParams();
            
            // Add form fields sesuai dengan Google Form Anda
            formData.append(FORM_FIELD_IDS.timestamp, new Date().toISOString());
            formData.append(FORM_FIELD_IDS.date, date);
            formData.append(FORM_FIELD_IDS.class, student.class);
            formData.append(FORM_FIELD_IDS.prayer, prayerName);
            formData.append(FORM_FIELD_IDS.studentName, student.name);
            formData.append(FORM_FIELD_IDS.status, getStatusText(student.status));
            formData.append(FORM_FIELD_IDS.nis, student.nis);
            
            try {
                const response = await fetch(GOOGLE_FORM_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors', // Important for Google Forms
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                // Dengan no-cors mode, kita tidak bisa membaca response
                // Jadi kita asumsikan berhasil jika tidak ada error network
                console.log(`Data terkirim untuk: ${student.name}`);
                return true;
                
            } catch (error) {
                throw new Error(`Network error: ${error.message}`);
            }
        }

        function getPrayerName(prayer) {
            const prayers = {
                'dhuha': 'Dhuha',
                'dhuhur': 'Dhuhur',
                'ashar': 'Ashar',
                'jumat': 'Jumat'
            };
            return prayers[prayer] || prayer;
        }

        function getStatusText(status) {
            const statusMap = {
                'sholat': 'Sholat',
                'berhalangan': 'Berhalangan',
                'tidak_sholat': 'Tidak Sholat'
            };
            return statusMap[status] || status;
        }

        // Progress Modal Functions
        function showProgressModal(current, total) {
            const modal = document.getElementById('progressModal');
            modal.classList.remove('hidden');
            updateProgressModal(current, total, 0, 0);
        }

        function updateProgressModal(current, total, success, error) {
            const percentage = (current / total) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${current}/${total}`;
            
            let message = `Mengirim data siswa...`;
            if (success > 0 || error > 0) {
                message += ` (✅ ${success} ❌ ${error})`;
            }
            document.getElementById('progressMessage').textContent = message;
        }

        function hideProgressModal() {
            const modal = document.getElementById('progressModal');
            modal.classList.add('hidden');
        }

        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            const successContent = document.getElementById('successContent');
            successContent.textContent = message;
            successElement.classList.remove('hidden');
            
            setTimeout(() => {
                successElement.classList.add('hidden');
            }, 8000);
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            const errorContent = document.getElementById('errorContent');
            errorContent.textContent = message;
            errorElement.classList.remove('hidden');
            
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 10000);
        }
    </script>
</body>
</html>
