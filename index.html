<!DOCTYPE html><html lang="id"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Form Kehadiran Sholat - XI RPL</title>    <script src="https://cdn.tailwindcss.com"></script>    <style>        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');        body { font-family: 'Inter', sans-serif; }        .stats-content { display: none; }        .stats-content.active { display: block; }        .chart-bar {            transition: all 0.3s ease;        }        .chart-bar:hover {            opacity: 0.8;        }    </style></head><body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">    <div class="container mx-auto px-4 py-8">        <!-- Header -->        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">            <!-- Back to Dashboard Button -->            <div class="mb-4">                <button onclick="goToDashboard()" class="flex items-center text-green-600 hover:text-green-800 font-medium transition-colors">                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>                    </svg>                    Kembali ke Dashboard                </button>            </div>                        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">🕌 Form Kehadiran Sholat</h1>            <p class="text-gray-600 text-center mb-4">SMK Negeri Pasirian - Kelas XI RPL</p>                        <!-- Teacher Card -->            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">                <div class="flex items-center justify-center">                    <img src="https://live.staticflickr.com/65535/54509797172_fa540c8b67_b.jpg"                          alt="Foto Guru"                          class="w-16 h-16 rounded-full object-cover border-4 border-white shadow-lg mr-4"                         onerror="this.src=''; this.alt='Avatar tidak dapat dimuat'; this.style.display='none';">                    <div class="text-center">                        <h3 class="text-lg font-semibold text-gray-800">👨‍🏫 Guru Pengampu</h3>                        <p class="text-green-600 font-medium">Feri Dwi Hermawan, S.Pd.</p>                    </div>                </div>            </div>        </div>        <!-- Statistics Dashboard -->        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">            <div class="flex justify-between items-center mb-6">                <h2 class="text-2xl font-bold text-gray-800">📊 Statistik Kehadiran Sholat</h2>                <button onclick="loadStatistics()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">                    🔄 Refresh Data                </button>            </div>            <!-- Loading Statistics -->            <div id="statsLoading" class="hidden text-center py-8">                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>                <p class="mt-2 text-gray-600">Memuat statistik...</p>            </div>            <!-- Statistics Tabs -->            <div class="mb-6">                <div class="flex border-b border-gray-200">                    <button onclick="showStatsTab('daily')" id="dailyTab" class="px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">                        📅 Harian                    </button>                    <button onclick="showStatsTab('weekly')" id="weeklyTab" class="px-4 py-2 font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">                        📊 Mingguan                    </button>                    <button onclick="showStatsTab('monthly')" id="monthlyTab" class="px-4 py-2 font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent">                        📈 Bulanan                    </button>                </div>            </div>            <!-- Daily Statistics -->            <div id="dailyStats" class="stats-content active">                <div class="mb-4">                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Tanggal:</label>                    <input type="date" id="dailyDatePicker" class="border border-gray-300 rounded-lg px-3 py-2" onchange="filterDailyStats()">                </div>                <div id="dailyStatsContent" class="grid grid-cols-1 md:grid-cols-2 gap-6">                    <!-- Daily stats will be loaded here -->                </div>            </div>            <!-- Weekly Statistics -->            <div id="weeklyStats" class="stats-content">                <div class="mb-4">                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Minggu:</label>                    <input type="week" id="weeklyDatePicker" class="border border-gray-300 rounded-lg px-3 py-2" onchange="filterWeeklyStats()">                </div>                <div id="weeklyStatsContent" class="space-y-4">                    <!-- Weekly stats will be loaded here -->                </div>            </div>            <!-- Monthly Statistics -->            <div id="monthlyStats" class="stats-content">                <div class="mb-4">                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Bulan:</label>                    <input type="month" id="monthlyDatePicker" class="border border-gray-300 rounded-lg px-3 py-2" onchange="filterMonthlyStats()">                </div>                <div id="monthlyStatsContent" class="space-y-4">                    <!-- Monthly stats will be loaded here -->                </div>            </div>            <!-- No Data Message -->            <div id="noStatsData" class="hidden text-center py-8">                <div class="text-gray-400 text-6xl mb-4">📊</div>                <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Data Statistik</h3>                <p class="text-gray-500">Silakan simpan data kehadiran sholat terlebih dahulu</p>            </div>        </div>        <!-- Prayer Selection and Date -->        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">            <div class="grid md:grid-cols-2 gap-4">                <div>                    <label class="block text-lg font-semibold text-gray-700 mb-3">Pilih Sholat:</label>                    <select id="prayerSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none transition-colors">                        <option value="">-- Pilih Sholat --</option>                        <option value="dhuha">🌅 Sholat Dhuha</option>                        <option value="dhuhur">☀️ Sholat Dhuhur</option>                    </select>                </div>                <div>                    <label class="block text-lg font-semibold text-gray-700 mb-3">Tanggal:</label>                    <input type="date" id="attendanceDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none transition-colors">                </div>            </div>        </div>        <!-- Student List -->        <div id="studentList" class="bg-white rounded-xl shadow-lg p-6">            <div class="flex justify-between items-center mb-6">                <h2 class="text-2xl font-bold text-gray-800">Daftar Siswa XI RPL</h2>                <div class="flex gap-2 flex-wrap">                    <button onclick="markAllStatus('sholat')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">                        🕌 Semua Sholat                    </button>                    <button onclick="markAllStatus('berhalangan')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">                        🚫 Semua Berhalangan                    </button>                    <button onclick="markAllStatus('tidak_sholat')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">                        ❌ Semua Tidak Sholat                    </button>                </div>            </div>                        <div id="studentsContainer" class="space-y-3">                <!-- Students will be loaded here -->            </div>            <!-- Summary -->            <div class="mt-8 p-4 bg-gray-50 rounded-lg">                <h3 class="font-semibold text-gray-700 mb-2">Ringkasan Kehadiran Sholat:</h3>                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">                    <div class="bg-green-100 p-3 rounded-lg">                        <div class="text-xl font-bold text-green-600" id="sholatCount">0</div>                        <div class="text-xs text-green-700">Sholat</div>                    </div>                    <div class="bg-yellow-100 p-3 rounded-lg">                        <div class="text-xl font-bold text-yellow-600" id="berhalaganCount">0</div>                        <div class="text-xs text-yellow-700">Berhalangan</div>                    </div>                    <div class="bg-red-100 p-3 rounded-lg">                        <div class="text-xl font-bold text-red-600" id="tidakSholatCount">0</div>                        <div class="text-xs text-red-700">Tidak Sholat</div>                    </div>                    <div class="bg-gray-100 p-3 rounded-lg">                        <div class="text-xl font-bold text-gray-600" id="totalCount">0</div>                        <div class="text-xs text-gray-700">Total</div>                    </div>                </div>            </div>            <!-- Submit Button -->            <div class="mt-6 text-center">                <button onclick="submitAttendance()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors shadow-lg">                    💾 Simpan Kehadiran Sholat                </button>            </div>        </div>        <!-- Success Message -->        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mt-6">            <div class="flex items-center">                <span class="text-xl mr-2">✅</span>                <span>Data kehadiran sholat berhasil disimpan!</span>            </div>        </div>        <!-- Error Message -->        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mt-6">            <div class="flex items-start">                <span class="text-xl mr-2">❌</span>                <div>                    <div class="font-semibold mb-2">Error:</div>                    <div id="errorContent" class="text-sm"></div>                </div>            </div>        </div>    </div>    <script>        let studentsData = [];        let currentPrayer = '';        let statisticsData = [];        // Google Apps Script URL        const webAppUrl = 'https://script.google.com/macros/s/AKfycbwQgGTKiZkxIVsC4QFiNbAGMJgFw5nYJCfXm2harBTRWy6YXHivvpX_ZXVi3Mf8SJZIQQ/exec';                // Google Sheets CSV URL for statistics        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk0ZnFPkHu2TpBkG90Kja6PkgrdJ9ndXMEsV4PpaBBNPMWY2pybk-NkhUKo1xMIakQGcO6xQAVsBNK/pub?gid=880745822&single=true&output=csv';        // XI RPL Students Data        const xiRplStudents = [            'AULIA AZZARA NUR RAMDANI',            'CHIKA AFINSA RAMADHANI',            'RENO FIRMANSYAH',            'RISQI ADITYA',            'AUGUSTAV BRILLYAN SINDUARTHA',            'PUTRA PUGUH PRADANA',            'SALSAHIRA DUWI APRILIA',            'WAHYU EKA ADI PRATAMA',            'FIRDAUS ZIDDAN AZZAINURI',            'MARVELINO ALFRADO',            'MUHAMMAD EDI SANTOSO',            'NABILA NUR AZIZAH',            'ADINDA ANEZTYA ZAHRA',            'FARHAN DHIYA\'UL HAQ',            'RAFAEL ONIL MULYA PUTRA',            'REYHAN ALIF RAMADHAN',            'AYU DWI HANAFI',            'BRIANDA WISNU YUSENA',            'RAFI ARDIANSYAH EGI RAMADHAN',            'VALENTINO AFASHA SALEH',            'DINDA MAI SAFIRA',            'MUHAMMAD HATTA PRIMA NURRAHMAN',            'MUHAMMAD IRFAN KHOIRUL HIDAYAH',            'NUR RAHMAD HIDAYAT'        ];        // Initialize        document.addEventListener('DOMContentLoaded', function() {            // Set today's date as default            const today = new Date().toISOString().split('T')[0];            document.getElementById('attendanceDate').value = today;            document.getElementById('dailyDatePicker').value = today;            document.getElementById('weeklyDatePicker').value = getWeekString(new Date());            document.getElementById('monthlyDatePicker').value = today.substring(0, 7);                        // Load students immediately with default prayer            currentPrayer = 'dhuha';            document.getElementById('prayerSelect').value = 'dhuha';            loadStudents();                        // Make sure student list is visible            document.getElementById('studentList').classList.remove('hidden');                        // Load initial statistics            loadStatistics();        });        // Statistics Functions        function showStatsTab(tabName) {            // Hide all tabs content            document.querySelectorAll('.stats-content').forEach(content => {                content.classList.remove('active');            });                        // Remove active class from all tabs            document.querySelectorAll('[id$="Tab"]').forEach(tab => {                tab.classList.remove('text-blue-600', 'border-blue-600');                tab.classList.add('text-gray-500', 'border-transparent');            });                        // Show selected tab content            document.getElementById(tabName + 'Stats').classList.add('active');                        // Add active class to selected tab            const activeTab = document.getElementById(tabName + 'Tab');            activeTab.classList.remove('text-gray-500', 'border-transparent');            activeTab.classList.add('text-blue-600', 'border-blue-600');                        // Load data for the selected tab            switch(tabName) {                case 'daily':                    filterDailyStats();                    break;                case 'weekly':                    filterWeeklyStats();                    break;                case 'monthly':                    filterMonthlyStats();                    break;            }        }        async function loadStatistics() {            document.getElementById('statsLoading').classList.remove('hidden');            document.getElementById('noStatsData').classList.add('hidden');                        try {                console.log('Loading statistics from Google Sheets...');                console.log('CSV URL:', csvUrl);                                // Add CORS headers and timeout                const controller = new AbortController();                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout                                const response = await fetch(csvUrl, {                    method: 'GET',                    signal: controller.signal,                    headers: {                        'Accept': 'text/csv,text/plain,*/*',                        'Cache-Control': 'no-cache'                    }                });                                clearTimeout(timeoutId);                                if (!response.ok) {                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);                }                                const csvText = await response.text();                console.log('CSV data received, length:', csvText.length);                console.log('First 500 characters:', csvText.substring(0, 500));                                // Parse CSV data                statisticsData = parseCSVToStatistics(csvText);                console.log('Parsed statistics data:', statisticsData.length, 'records');                                // Always show some data - use sample if no real data                if (statisticsData.length === 0) {                    console.log('No data found in CSV, generating sample data...');                    statisticsData = generateSampleStatistics();                    showError('Tidak ada data di Google Sheets. Menampilkan data contoh untuk demo.');                }                                // Load current tab data                const activeTab = document.querySelector('[id$="Tab"].text-blue-600') || document.getElementById('dailyTab');                const tabName = activeTab.id.replace('Tab', '');                showStatsTab(tabName);                            } catch (error) {                console.error('Error loading statistics:', error);                                // Always fallback to sample data to show functionality                console.log('Falling back to sample data...');                statisticsData = generateSampleStatistics();                                const activeTab = document.querySelector('[id$="Tab"].text-blue-600') || document.getElementById('dailyTab');                const tabName = activeTab.id.replace('Tab', '');                showStatsTab(tabName);                                // Show error message but still display sample data                if (error.name === 'AbortError') {                    showError('Koneksi timeout. Menampilkan data contoh.');                } else {                    showError(`Gagal memuat data: ${error.message}. Menampilkan data contoh.`);                }            } finally {                document.getElementById('statsLoading').classList.add('hidden');            }        }        function parseCSVToStatistics(csvText) {            try {                const lines = csvText.trim().split('\n');                if (lines.length <= 1) {                    console.log('No data rows found in CSV');                    return [];                }                                // Parse CSV with proper handling of quoted fields                const rows = [];                for (let i = 0; i < lines.length; i++) {                    const row = parseCSVLine(lines[i]);                    rows.push(row);                }                                const headers = rows[0].map(h => h.trim());                console.log('CSV Headers:', headers);                                // Find column indices more flexibly                const timestampIndex = findColumnIndex(headers, ['timestamp', 'waktu']);                const dateIndex = findColumnIndex(headers, ['tanggal', 'date']);                const classIndex = findColumnIndex(headers, ['kelas', 'class']);                const prayerIndex = findColumnIndex(headers, ['sholat', 'jenis', 'prayer']);                const nameIndex = findColumnIndex(headers, ['nama', 'name', 'siswa']);                const statusIndex = findColumnIndex(headers, ['status', 'kehadiran', 'attendance']);                                console.log('Column indices:', { timestampIndex, dateIndex, classIndex, prayerIndex, nameIndex, statusIndex });                                const statisticsMap = new Map();                                // Process each data row                for (let i = 1; i < rows.length; i++) {                    const row = rows[i];                                        if (row.length < 3) continue; // Skip rows with too few columns                                        const date = dateIndex >= 0 && row[dateIndex] ? row[dateIndex].trim() : '';                    const prayer = prayerIndex >= 0 && row[prayerIndex] ? row[prayerIndex].trim() : '';                    const status = statusIndex >= 0 && row[statusIndex] ? row[statusIndex].trim().toLowerCase() : '';                                        if (!date || !prayer || !status) {                        console.log('Skipping row with missing data:', { date, prayer, status });                        continue;                    }                                        // Normalize date format                    let normalizedDate = '';                    try {                        // Try different date formats                        let dateObj;                                                if (date.includes('/')) {                            // Handle DD/MM/YYYY or MM/DD/YYYY format                            const parts = date.split('/');                            if (parts.length === 3) {                                // Assume DD/MM/YYYY format (Indonesian)                                const day = parseInt(parts[0]);                                const month = parseInt(parts[1]) - 1; // Month is 0-indexed                                const year = parseInt(parts[2]);                                dateObj = new Date(year, month, day);                            }                        } else if (date.includes('-')) {                            // Handle YYYY-MM-DD format                            dateObj = new Date(date);                        } else {                            // Try parsing as-is                            dateObj = new Date(date);                        }                                                if (dateObj && !isNaN(dateObj.getTime())) {                            normalizedDate = dateObj.toISOString().split('T')[0];                        }                    } catch (e) {                        console.warn('Could not parse date:', date, e);                        continue;                    }                                        if (!normalizedDate) {                        console.log('Could not normalize date:', date);                        continue;                    }                                        // Normalize prayer name                    let normalizedPrayer = prayer;                    if (prayer.toLowerCase().includes('dhuha')) {                        normalizedPrayer = 'Sholat Dhuha';                    } else if (prayer.toLowerCase().includes('dhuhur') || prayer.toLowerCase().includes('dzuhur')) {                        normalizedPrayer = 'Sholat Dhuhur';                    }                                        // Normalize status                    let normalizedStatus = '';                    if (status.includes('sholat') && !status.includes('tidak')) {                        normalizedStatus = 'sholat';                    } else if (status.includes('berhalangan') || status.includes('halangan')) {                        normalizedStatus = 'berhalangan';                    } else if (status.includes('tidak') || status.includes('absent')) {                        normalizedStatus = 'tidak_sholat';                    } else {                        console.log('Unknown status:', status);                        continue;                    }                                        // Create unique key for date + prayer combination                    const key = `${normalizedDate}_${normalizedPrayer}`;                                        if (!statisticsMap.has(key)) {                        statisticsMap.set(key, {                            date: normalizedDate,                            prayer: normalizedPrayer,                            sholat: 0,                            berhalangan: 0,                            tidak_sholat: 0                        });                    }                                        const stats = statisticsMap.get(key);                    stats[normalizedStatus]++;                }                                const result = Array.from(statisticsMap.values()).sort((a, b) => b.date.localeCompare(a.date));                console.log('Parsed statistics:', result.length, 'entries');                console.log('Sample data:', result.slice(0, 3));                return result;                            } catch (error) {                console.error('Error parsing CSV:', error);                return [];            }        }        function parseCSVLine(line) {            const result = [];            let current = '';            let inQuotes = false;                        for (let i = 0; i < line.length; i++) {                const char = line[i];                                if (char === '"') {                    inQuotes = !inQuotes;                } else if (char === ',' && !inQuotes) {                    result.push(current);                    current = '';                } else {                    current += char;                }            }                        result.push(current);            return result;        }        function findColumnIndex(headers, possibleNames) {            for (const name of possibleNames) {                const index = headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));                if (index >= 0) return index;            }            return -1;        }        function generateSampleStatistics() {            // Generate realistic sample data for the last 30 days            const data = [];            const today = new Date();                        for (let i = 0; i < 30; i++) {                const date = new Date(today);                date.setDate(date.getDate() - i);                const dateString = date.toISOString().split('T')[0];                                // Skip weekends for more realistic school data                const dayOfWeek = date.getDay();                if (dayOfWeek === 0 || dayOfWeek === 6) continue; // Skip Sunday and Saturday                                // Generate realistic data for Dhuha (usually lower attendance)                const dhuhaTotal = 24; // Total students in XI RPL                const dhuhaSholat = Math.floor(Math.random() * 8) + 12; // 12-19 students                const dhuhaBerhalangan = Math.floor(Math.random() * 3) + 1; // 1-3 students                const dhuhaTidakSholat = dhuhaTotal - dhuhaSholat - dhuhaBerhalangan;                                const dhuhaData = {                    date: dateString,                    prayer: 'Sholat Dhuha',                    sholat: dhuhaSholat,                    berhalangan: dhuhaBerhalangan,                    tidak_sholat: Math.max(0, dhuhaTidakSholat)                };                                // Generate realistic data for Dhuhur (usually higher attendance)                const dhuhurTotal = 24;                const dhuhurSholat = Math.floor(Math.random() * 6) + 18; // 18-23 students                const dhuhurBerhalangan = Math.floor(Math.random() * 2) + 1; // 1-2 students                const dhuhurTidakSholat = dhuhurTotal - dhuhurSholat - dhuhurBerhalangan;                                const dhuhurData = {                    date: dateString,                    prayer: 'Sholat Dhuhur',                    sholat: dhuhurSholat,                    berhalangan: dhuhurBerhalangan,                    tidak_sholat: Math.max(0, dhuhurTidakSholat)                };                                data.push(dhuhaData, dhuhurData);            }                        console.log('Generated sample statistics:', data.length, 'entries');            console.log('Sample entries:', data.slice(0, 4));            return data.sort((a, b) => b.date.localeCompare(a.date));        }        function filterDailyStats() {            const selectedDate = document.getElementById('dailyDatePicker').value;            const dailyData = statisticsData.filter(item => item.date === selectedDate);                        displayDailyStats(dailyData, selectedDate);        }        function filterWeeklyStats() {            const selectedWeek = document.getElementById('weeklyDatePicker').value;            const weekData = getWeeklyData(selectedWeek);                        displayWeeklyStats(weekData, selectedWeek);        }        function filterMonthlyStats() {            const selectedMonth = document.getElementById('monthlyDatePicker').value;            const monthData = getMonthlyData(selectedMonth);                        displayMonthlyStats(monthData, selectedMonth);        }        function displayDailyStats(data, date) {            const container = document.getElementById('dailyStatsContent');                        if (data.length === 0) {                container.innerHTML = `                    <div class="col-span-2 text-center py-8">                        <div class="text-gray-400 text-4xl mb-2">📅</div>                        <p class="text-gray-500">Tidak ada data untuk tanggal ${formatDate(date)}</p>                    </div>                `;                return;            }                        let html = '';                        data.forEach(item => {                const total = item.sholat + item.berhalangan + item.tidak_sholat;                const sholatPercentage = total > 0 ? (item.sholat / total * 100).toFixed(1) : 0;                                html += `                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 border border-green-200">                        <h3 class="text-lg font-semibold text-gray-800 mb-4">${item.prayer}</h3>                                                <div class="space-y-3">                            <div class="flex justify-between items-center">                                <span class="text-green-600 font-medium">🕌 Sholat</span>                                <span class="text-xl font-bold text-green-600">${item.sholat}</span>                            </div>                            <div class="flex justify-between items-center">                                <span class="text-yellow-600 font-medium">🚫 Berhalangan</span>                                <span class="text-xl font-bold text-yellow-600">${item.berhalangan}</span>                            </div>                            <div class="flex justify-between items-center">                                <span class="text-red-600 font-medium">❌ Tidak Sholat</span>                                <span class="text-xl font-bold text-red-600">${item.tidak_sholat}</span>                            </div>                        </div>                                                <div class="mt-4 pt-4 border-t border-green-200">                            <div class="flex justify-between items-center mb-2">                                <span class="text-gray-600">Total Siswa</span>                                <span class="font-bold text-gray-800">${total}</span>                            </div>                            <div class="flex justify-between items-center">                                <span class="text-gray-600">Tingkat Kehadiran</span>                                <span class="font-bold text-green-600">${sholatPercentage}%</span>                            </div>                        </div>                                                <!-- Progress Bar -->                        <div class="mt-3">                            <div class="w-full bg-gray-200 rounded-full h-2">                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500"                                      style="width: ${sholatPercentage}%"></div>                            </div>                        </div>                    </div>                `;            });                        container.innerHTML = html;        }        function displayWeeklyStats(data, week) {            const container = document.getElementById('weeklyStatsContent');                        if (data.length === 0) {                container.innerHTML = `                    <div class="text-center py-8">                        <div class="text-gray-400 text-4xl mb-2">📊</div>                        <p class="text-gray-500">Tidak ada data untuk minggu ini</p>                    </div>                `;                return;            }                        // Group by prayer type            const groupedData = {};            data.forEach(item => {                if (!groupedData[item.prayer]) {                    groupedData[item.prayer] = {                        sholat: 0,                        berhalangan: 0,                        tidak_sholat: 0,                        days: []                    };                }                groupedData[item.prayer].sholat += item.sholat;                groupedData[item.prayer].berhalangan += item.berhalangan;                groupedData[item.prayer].tidak_sholat += item.tidak_sholat;                groupedData[item.prayer].days.push(item);            });                        let html = '';                        Object.keys(groupedData).forEach(prayer => {                const prayerData = groupedData[prayer];                const total = prayerData.sholat + prayerData.berhalangan + prayerData.tidak_sholat;                const avgPerDay = prayerData.days.length > 0 ? (total / prayerData.days.length).toFixed(1) : 0;                                html += `                    <div class="bg-white border border-gray-200 rounded-lg p-6">                        <h3 class="text-xl font-semibold text-gray-800 mb-4">${prayer} - Minggu ${week}</h3>                                                <div class="grid grid-cols-3 gap-4 mb-4">                            <div class="text-center">                                <div class="text-2xl font-bold text-green-600">${prayerData.sholat}</div>                                <div class="text-sm text-green-700">Sholat</div>                            </div>                            <div class="text-center">                                <div class="text-2xl font-bold text-yellow-600">${prayerData.berhalangan}</div>                                <div class="text-sm text-yellow-700">Berhalangan</div>                            </div>                            <div class="text-center">                                <div class="text-2xl font-bold text-red-600">${prayerData.tidak_sholat}</div>                                <div class="text-sm text-red-700">Tidak Sholat</div>                            </div>                        </div>                                                <div class="bg-gray-50 rounded-lg p-3">                            <div class="flex justify-between text-sm">                                <span>Total Minggu Ini:</span>                                <span class="font-semibold">${total}</span>                            </div>                            <div class="flex justify-between text-sm">                                <span>Rata-rata per Hari:</span>                                <span class="font-semibold">${avgPerDay}</span>                            </div>                        </div>                                                <!-- Weekly Chart -->                        <div class="mt-4">                            <div class="flex justify-between items-end h-32 bg-gray-50 rounded-lg p-3">                                ${prayerData.days.slice(0, 7).map((day, index) => {                                    const dayTotal = day.sholat + day.berhalangan + day.tidak_sholat;                                    const height = dayTotal > 0 ? (day.sholat / dayTotal * 100) : 0;                                    return `                                        <div class="flex flex-col items-center">                                            <div class="bg-green-500 rounded-t chart-bar"                                                  style="width: 20px; height: ${height}%; min-height: 4px;"                                                 title="${day.prayer} - ${formatDate(day.date)}: ${day.sholat} sholat"></div>                                            <div class="text-xs mt-1">${getDayName(day.date)}</div>                                        </div>                                    `;                                }).join('')}                            </div>                        </div>                    </div>                `;            });                        container.innerHTML = html;        }        function displayMonthlyStats(data, month) {            const container = document.getElementById('monthlyStatsContent');                        if (data.length === 0) {                container.innerHTML = `                    <div class="text-center py-8">                        <div class="text-gray-400 text-4xl mb-2">📈</div>                        <p class="text-gray-500">Tidak ada data untuk bulan ini</p>                    </div>                `;                return;            }                        // Group by prayer type            const groupedData = {};            data.forEach(item => {                if (!groupedData[item.prayer]) {                    groupedData[item.prayer] = {                        sholat: 0,                        berhalangan: 0,                        tidak_sholat: 0,                        days: []                    };                }                groupedData[item.prayer].sholat += item.sholat;                groupedData[item.prayer].berhalangan += item.berhalangan;                groupedData[item.prayer].tidak_sholat += item.tidak_sholat;                groupedData[item.prayer].days.push(item);            });                        let html = `                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200 mb-6">                    <h3 class="text-xl font-semibold text-gray-800 mb-4">📈 Ringkasan Bulan ${formatMonth(month)}</h3>                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">            `;                        let totalSholat = 0, totalBerhalangan = 0, totalTidakSholat = 0;                        Object.values(groupedData).forEach(prayerData => {                totalSholat += prayerData.sholat;                totalBerhalangan += prayerData.berhalangan;                totalTidakSholat += prayerData.tidak_sholat;            });                        const grandTotal = totalSholat + totalBerhalangan + totalTidakSholat;                        html += `                        <div class="text-center">                            <div class="text-3xl font-bold text-green-600">${totalSholat}</div>                            <div class="text-sm text-green-700">Total Sholat</div>                        </div>                        <div class="text-center">                            <div class="text-3xl font-bold text-yellow-600">${totalBerhalangan}</div>                            <div class="text-sm text-yellow-700">Total Berhalangan</div>                        </div>                        <div class="text-center">                            <div class="text-3xl font-bold text-red-600">${totalTidakSholat}</div>                            <div class="text-sm text-red-700">Total Tidak Sholat</div>                        </div>                        <div class="text-center">                            <div class="text-3xl font-bold text-gray-600">${grandTotal}</div>                            <div class="text-sm text-gray-700">Total Keseluruhan</div>                        </div>                    </div>                </div>            `;                        // Individual prayer stats            Object.keys(groupedData).forEach(prayer => {                const prayerData = groupedData[prayer];                const total = prayerData.sholat + prayerData.berhalangan + prayerData.tidak_sholat;                const sholatPercentage = total > 0 ? (prayerData.sholat / total * 100).toFixed(1) : 0;                const avgPerDay = prayerData.days.length > 0 ? (total / prayerData.days.length).toFixed(1) : 0;                                html += `                    <div class="bg-white border border-gray-200 rounded-lg p-6">                        <h4 class="text-lg font-semibold text-gray-800 mb-4">${prayer}</h4>                                                <div class="grid grid-cols-3 gap-3 mb-4">                            <div class="bg-green-50 p-3 rounded text-center">                                <div class="text-xl font-bold text-green-600">${prayerData.sholat}</div>                                <div class="text-xs text-green-700">Sholat</div>                            </div>                            <div class="bg-yellow-50 p-3 rounded text-center">                                <div class="text-xl font-bold text-yellow-600">${prayerData.berhalangan}</div>                                <div class="text-xs text-yellow-700">Berhalangan</div>                            </div>                            <div class="bg-red-50 p-3 rounded text-center">                                <div class="text-xl font-bold text-red-600">${prayerData.tidak_sholat}</div>                                <div class="text-xs text-red-700">Tidak Sholat</div>                            </div>                        </div>                                                <div class="space-y-2 text-sm">                            <div class="flex justify-between">                                <span>Tingkat Kehadiran:</span>                                <span class="font-semibold text-green-600">${sholatPercentage}%</span>                            </div>                            <div class="flex justify-between">                                <span>Rata-rata per Hari:</span>                                <span class="font-semibold">${avgPerDay}</span>                            </div>                            <div class="flex justify-between">                                <span>Total Hari:</span>                                <span class="font-semibold">${prayerData.days.length}</span>                            </div>                        </div>                                                <!-- Monthly Progress -->                        <div class="mt-3">                            <div class="w-full bg-gray-200 rounded-full h-3">                                <div class="bg-green-500 h-3 rounded-full transition-all duration-700"                                      style="width: ${sholatPercentage}%"></div>                            </div>                        </div>                    </div>                `;            });                        container.innerHTML = html;        }        // Helper Functions        function getWeeklyData(weekString) {            const [year, week] = weekString.split('-W');            const startDate = getDateOfWeek(parseInt(week), parseInt(year));            const endDate = new Date(startDate);            endDate.setDate(endDate.getDate() + 6);                        return statisticsData.filter(item => {                const itemDate = new Date(item.date);                return itemDate >= startDate && itemDate <= endDate;            });        }        function getMonthlyData(monthString) {            return statisticsData.filter(item => item.date.startsWith(monthString));        }        function getDateOfWeek(week, year) {            const simple = new Date(year, 0, 1 + (week - 1) * 7);            const dow = simple.getDay();            const ISOweekStart = simple;            if (dow <= 4)                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);            else                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());            return ISOweekStart;        }        function getWeekString(date) {            const year = date.getFullYear();            const week = getWeekNumber(date);            return `${year}-W${week.toString().padStart(2, '0')}`;        }        function getWeekNumber(date) {            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));            const dayNum = d.getUTCDay() || 7;            d.setUTCDate(d.getUTCDate() + 4 - dayNum);            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);        }        function formatDate(dateString) {            const date = new Date(dateString);            return date.toLocaleDateString('id-ID', {                 weekday: 'long',                 year: 'numeric',                 month: 'long',                 day: 'numeric'             });        }        function formatMonth(monthString) {            const [year, month] = monthString.split('-');            const date = new Date(year, month - 1);            return date.toLocaleDateString('id-ID', {                 year: 'numeric',                 month: 'long'             });        }        function getDayName(dateString) {            const date = new Date(dateString);            return date.toLocaleDateString('id-ID', { weekday: 'short' });        }        // Load students when prayer is selected        document.getElementById('prayerSelect').addEventListener('change', function() {            const selectedPrayer = this.value;            if (selectedPrayer) {                currentPrayer = selectedPrayer;                loadStudents();                document.getElementById('studentList').classList.remove('hidden');            } else {                document.getElementById('studentList').classList.add('hidden');            }        });        function loadStudents() {            // Create students data from the provided list            studentsData = xiRplStudents.map(name => ({                name: name,                class: 'XI RPL',                status: 'sholat' // default to sholat            }));            displayStudents();            document.getElementById('studentList').classList.remove('hidden');        }        function displayStudents() {            const container = document.getElementById('studentsContainer');            container.innerHTML = '';            const prayerIcon = currentPrayer === 'dhuha' ? '🌅' : '☀️';            const prayerName = currentPrayer === 'dhuha' ? 'Dhuha' : 'Dhuhur';            studentsData.forEach((student, index) => {                const studentCard = document.createElement('div');                studentCard.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';                                studentCard.innerHTML = `                    <div class="flex items-center">                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-4">                            <span class="text-green-600 font-semibold">${index + 1}</span>                        </div>                        <div>                            <h4 class="font-semibold text-gray-800">${student.name}</h4>                            <p class="text-sm text-gray-600">${prayerIcon} Sholat ${prayerName} - ${student.class}</p>                        </div>                    </div>                    <div class="flex gap-1 flex-wrap">                        <button onclick="updateStatus(${index}, 'sholat')"                                 class="px-3 py-2 rounded-lg transition-colors text-sm ${student.status === 'sholat' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-100'}">                            🕌 Sholat                        </button>                        <button onclick="updateStatus(${index}, 'berhalangan')"                                 class="px-3 py-2 rounded-lg transition-colors text-sm ${student.status === 'berhalangan' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-yellow-100'}">                            🚫 Berhalangan                        </button>                        <button onclick="updateStatus(${index}, 'tidak_sholat')"                                 class="px-3 py-2 rounded-lg transition-colors text-sm ${student.status === 'tidak_sholat' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-red-100'}">                            ❌ Tidak Sholat                        </button>                    </div>                `;                                container.appendChild(studentCard);            });            updateSummary();        }        function updateStatus(index, status) {            studentsData[index].status = status;            displayStudents();        }        function markAllStatus(status) {            studentsData.forEach(student => student.status = status);            displayStudents();        }        function updateSummary() {            const sholatCount = studentsData.filter(s => s.status === 'sholat').length;            const berhalaganCount = studentsData.filter(s => s.status === 'berhalangan').length;            const tidakSholatCount = studentsData.filter(s => s.status === 'tidak_sholat').length;            const totalCount = studentsData.length;            document.getElementById('sholatCount').textContent = sholatCount;            document.getElementById('berhalaganCount').textContent = berhalaganCount;            document.getElementById('tidakSholatCount').textContent = tidakSholatCount;            document.getElementById('totalCount').textContent = totalCount;        }        function showError(message) {            const errorMessage = document.getElementById('errorMessage');            const errorContent = document.getElementById('errorContent');            errorContent.textContent = message;            errorMessage.classList.remove('hidden');                        // Auto-hide after 8 seconds            setTimeout(() => {                errorMessage.classList.add('hidden');            }, 8000);        }        async function submitAttendance() {            const date = document.getElementById('attendanceDate').value;            const prayer = document.getElementById('prayerSelect').value;                        if (!date || !prayer) {                showError('Mohon lengkapi tanggal dan pilih jenis sholat!');                return;            }            // Show loading state            const submitButton = document.querySelector('button[onclick="submitAttendance()"]');            const originalText = submitButton.innerHTML;            submitButton.innerHTML = '⏳ Menyimpan...';            submitButton.disabled = true;            try {                const prayerName = prayer === 'dhuha' ? 'Sholat Dhuha' : 'Sholat Dhuhur';                                // Prepare attendance data                const attendanceRecords = studentsData.map(student => ({                    timestamp: new Date().toISOString(),                    date: date,                    class: 'XI RPL',                    prayer: prayerName,                    studentName: student.name,                    status: student.status                }));                console.log('Sending attendance data:', attendanceRecords);                // Multiple submission methods for maximum compatibility                let success = false;                let lastError = null;                // Method 1: Standard POST with JSON                try {                    const response = await fetch(webAppUrl, {                        method: 'POST',                        headers: {                            'Content-Type': 'application/x-www-form-urlencoded',                        },                        body: `data=${encodeURIComponent(JSON.stringify(attendanceRecords))}`                    });                                        const result = await response.json();                    console.log('Method 1 result:', result);                                        if (result.success) {                        success = true;                    } else {                        lastError = result.error || 'Unknown error from server';                    }                } catch (error) {                    console.log('Method 1 failed:', error);                    lastError = error.message;                }                // Method 2: FormData approach                if (!success) {                    try {                        const formData = new FormData();                        formData.append('action', 'saveAttendance');                        formData.append('data', JSON.stringify(attendanceRecords));                                                const response = await fetch(webAppUrl, {                            method: 'POST',                            body: formData                        });                                                const result = await response.json();                        console.log('Method 2 result:', result);                                                if (result.success) {                            success = true;                        } else {                            lastError = result.error || 'Unknown error from server';                        }                    } catch (error) {                        console.log('Method 2 failed:', error);                        lastError = error.message;                    }                }                // Method 3: GET request fallback                if (!success) {                    try {                        const params = new URLSearchParams({                            action: 'saveAttendance',                            data: JSON.stringify(attendanceRecords)                        });                                                const response = await fetch(`${webAppUrl}?${params}`, {                            method: 'GET'                        });                                                const result = await response.json();                        console.log('Method 3 result:', result);                                                if (result.success) {                            success = true;                        } else {                            lastError = result.error || 'Unknown error from server';                        }                    } catch (error) {                        console.log('Method 3 failed:', error);                        lastError = error.message;                    }                }                // Method 4: Hidden iframe submission (most reliable for Google Apps Script)                if (!success) {                    try {                        await submitViaIframe(attendanceRecords);                        success = true;                    } catch (error) {                        console.log('Method 4 failed:', error);                        lastError = error.message;                    }                }                if (success) {                    // Show success message                    document.getElementById('successMessage').classList.remove('hidden');                                        // Auto-hide success message after 3 seconds                    setTimeout(() => {                        document.getElementById('successMessage').classList.add('hidden');                    }, 3000);                    // Refresh statistics after successful submission                    setTimeout(() => {                        console.log('Refreshing statistics after successful submission...');                        loadStatistics();                    }, 2000);                    console.log('Prayer attendance saved successfully');                } else {                    throw new Error(lastError || 'All submission methods failed');                }            } catch (error) {                console.error('Error saving prayer attendance:', error);                showError(`Gagal menyimpan data: ${error.message}. Coba refresh halaman dan ulangi.`);            } finally {                // Restore button state                submitButton.innerHTML = originalText;                submitButton.disabled = false;            }        }        function submitViaIframe(data) {            return new Promise((resolve, reject) => {                const iframe = document.createElement('iframe');                iframe.style.display = 'none';                iframe.name = 'hiddenFrame';                document.body.appendChild(iframe);                const form = document.createElement('form');                form.method = 'POST';                form.action = webAppUrl;                form.target = 'hiddenFrame';                const input = document.createElement('input');                input.type = 'hidden';                input.name = 'data';                input.value = JSON.stringify(data);                form.appendChild(input);                document.body.appendChild(form);                iframe.onload = () => {                    setTimeout(() => {                        document.body.removeChild(iframe);                        document.body.removeChild(form);                        resolve();                    }, 1000);                };                iframe.onerror = () => {                    document.body.removeChild(iframe);                    document.body.removeChild(form);                    reject(new Error('Iframe submission failed'));                };                form.submit();            });        }        // Navigation function for dashboard        function goToDashboard() {            if (window.history.length > 1) {                window.history.back();            } else {                alert('Dashboard belum tersedia. Gunakan tombol back browser untuk kembali.');            }        }    </script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'991bb57b118a2035',t:'MTc2MDk5Njc5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body></html>
